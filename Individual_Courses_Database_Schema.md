# Database Schema Update for Individual Courses

**Author:** Manus AI  
**Date:** December 30, 2024  
**Project:** BridgeFacile Individual Course Support  

## Overview

Following the successful addition of the "Cours Particuliers en Visio" (Individual Video Courses) offering to the BridgeFacile website, this document outlines the necessary database schema updates to support the new individual course functionality. The individual course offering represents a premium, personalized learning experience that requires specialized data management capabilities.

## New Table: individual_courses

To properly support individual courses with custom pricing, scheduling, and personalized content, we need to create a dedicated table that captures the unique requirements of one-to-one instruction.

### Table Structure

```sql
CREATE TABLE public.individual_courses (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    student_id BIGINT REFERENCES public.students(id) ON DELETE CASCADE,
    instructor_name TEXT DEFAULT 'Thomas Joannes',
    course_status TEXT CHECK (course_status IN ('inquiry', 'quoted', 'confirmed', 'in_progress', 'completed', 'cancelled')) DEFAULT 'inquiry',
    
    -- Scheduling Information
    preferred_schedule TEXT, -- Student's preferred schedule description
    actual_schedule JSONB, -- Confirmed schedule as JSON array of sessions
    total_hours INTEGER, -- Total hours of instruction
    sessions_completed INTEGER DEFAULT 0,
    
    -- Pricing Information
    quoted_price DECIMAL(10,2), -- Custom quoted price
    price_per_hour DECIMAL(10,2), -- Hourly rate
    payment_status TEXT CHECK (payment_status IN ('pending', 'partial', 'paid', 'refunded')) DEFAULT 'pending',
    
    -- Course Customization
    student_level TEXT CHECK (student_level IN ('beginner', 'intermediate', 'advanced', 'expert')),
    specific_goals TEXT, -- Student's specific learning objectives
    custom_curriculum JSONB, -- Customized lesson plan as JSON
    learning_pace TEXT CHECK (learning_pace IN ('slow', 'normal', 'fast', 'intensive')),
    
    -- Communication and Notes
    initial_inquiry TEXT, -- Student's initial message/requirements
    instructor_notes TEXT, -- Private notes for instructor
    student_feedback TEXT, -- Student feedback during course
    
    -- Timestamps
    inquiry_date TIMESTAMPTZ DEFAULT NOW(),
    quote_sent_date TIMESTAMPTZ,
    course_start_date TIMESTAMPTZ,
    course_end_date TIMESTAMPTZ,
    last_session_date TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Indexes for Performance

```sql
-- Index for student lookups
CREATE INDEX idx_individual_courses_student_id ON public.individual_courses(student_id);

-- Index for status queries
CREATE INDEX idx_individual_courses_status ON public.individual_courses(course_status);

-- Index for scheduling queries
CREATE INDEX idx_individual_courses_dates ON public.individual_courses(course_start_date, course_end_date);

-- Index for payment tracking
CREATE INDEX idx_individual_courses_payment ON public.individual_courses(payment_status);
```

## Updated Table: contacts

The existing contacts table should be enhanced to better capture individual course inquiries and link them to potential individual courses.

### Additional Columns

```sql
-- Add course type preference to contacts table
ALTER TABLE public.contacts ADD COLUMN course_type_interest TEXT CHECK (course_type_interest IN ('live_group', 'autonomous', 'individual', 'multiple', 'undecided'));

-- Add urgency level for individual course inquiries
ALTER TABLE public.contacts ADD COLUMN urgency_level TEXT CHECK (urgency_level IN ('low', 'medium', 'high', 'urgent')) DEFAULT 'medium';

-- Add budget range indication
ALTER TABLE public.contacts ADD COLUMN budget_range TEXT;

-- Add availability information
ALTER TABLE public.contacts ADD COLUMN availability_info TEXT;

-- Link to individual course if inquiry leads to course creation
ALTER TABLE public.contacts ADD COLUMN individual_course_id BIGINT REFERENCES public.individual_courses(id);
```

## New Table: individual_sessions

To track individual sessions within an individual course, we need a dedicated sessions table.

### Table Structure

```sql
CREATE TABLE public.individual_sessions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    individual_course_id BIGINT REFERENCES public.individual_courses(id) ON DELETE CASCADE,
    
    -- Session Details
    session_number INTEGER NOT NULL,
    session_date TIMESTAMPTZ NOT NULL,
    duration_minutes INTEGER DEFAULT 60,
    session_status TEXT CHECK (session_status IN ('scheduled', 'completed', 'cancelled', 'rescheduled')) DEFAULT 'scheduled',
    
    -- Session Content
    topics_covered TEXT[],
    lesson_plan TEXT,
    homework_assigned TEXT,
    student_performance TEXT,
    
    -- Technical Details
    meeting_link TEXT, -- Video conference link
    recording_link TEXT, -- Session recording if available
    materials_shared TEXT[], -- Links to shared materials
    
    -- Notes and Feedback
    instructor_notes TEXT,
    student_questions TEXT,
    next_session_prep TEXT,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(individual_course_id, session_number)
);
```

### Indexes

```sql
-- Index for course session lookups
CREATE INDEX idx_individual_sessions_course_id ON public.individual_sessions(individual_course_id);

-- Index for scheduling queries
CREATE INDEX idx_individual_sessions_date ON public.individual_sessions(session_date);

-- Index for status tracking
CREATE INDEX idx_individual_sessions_status ON public.individual_sessions(session_status);
```

## Updated Table: subscriptions

The subscriptions table should be enhanced to support individual course subscriptions with their unique characteristics.

### Additional Columns

```sql
-- Add support for individual course subscriptions
ALTER TABLE public.subscriptions ADD COLUMN is_individual_course BOOLEAN DEFAULT FALSE;

-- Link to individual course details
ALTER TABLE public.subscriptions ADD COLUMN individual_course_id BIGINT REFERENCES public.individual_courses(id);

-- Custom pricing for individual courses
ALTER TABLE public.subscriptions ADD COLUMN custom_price DECIMAL(10,2);

-- Flexible duration for individual courses
ALTER TABLE public.subscriptions ADD COLUMN custom_duration_hours INTEGER;
```

## New Table: course_quotes

To manage the quoting process for individual courses, we need a dedicated quotes table.

### Table Structure

```sql
CREATE TABLE public.course_quotes (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    individual_course_id BIGINT REFERENCES public.individual_courses(id) ON DELETE CASCADE,
    contact_id BIGINT REFERENCES public.contacts(id),
    
    -- Quote Details
    quote_number TEXT UNIQUE NOT NULL, -- Format: IQ-YYYY-NNNN
    total_price DECIMAL(10,2) NOT NULL,
    hourly_rate DECIMAL(10,2) NOT NULL,
    estimated_hours INTEGER NOT NULL,
    
    -- Quote Breakdown
    base_price DECIMAL(10,2),
    customization_fee DECIMAL(10,2) DEFAULT 0,
    materials_fee DECIMAL(10,2) DEFAULT 0,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    
    -- Quote Status
    quote_status TEXT CHECK (quote_status IN ('draft', 'sent', 'viewed', 'accepted', 'rejected', 'expired', 'revised')) DEFAULT 'draft',
    
    -- Validity
    valid_until TIMESTAMPTZ NOT NULL,
    
    -- Terms and Conditions
    terms_conditions TEXT,
    payment_terms TEXT DEFAULT 'Payment due before course start',
    cancellation_policy TEXT,
    
    -- Communication
    quote_message TEXT, -- Message sent with quote
    client_response TEXT, -- Client's response to quote
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    sent_at TIMESTAMPTZ,
    viewed_at TIMESTAMPTZ,
    responded_at TIMESTAMPTZ,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Automatic Quote Number Generation

```sql
-- Function to generate quote numbers
CREATE OR REPLACE FUNCTION generate_quote_number()
RETURNS TEXT AS $$
DECLARE
    year_part TEXT;
    sequence_part TEXT;
    next_number INTEGER;
BEGIN
    year_part := EXTRACT(YEAR FROM NOW())::TEXT;
    
    -- Get next sequence number for the current year
    SELECT COALESCE(MAX(CAST(SUBSTRING(quote_number FROM 'IQ-' || year_part || '-(.*)') AS INTEGER)), 0) + 1
    INTO next_number
    FROM public.course_quotes
    WHERE quote_number LIKE 'IQ-' || year_part || '-%';
    
    sequence_part := LPAD(next_number::TEXT, 4, '0');
    
    RETURN 'IQ-' || year_part || '-' || sequence_part;
END;
$$ LANGUAGE plpgsql;

-- Trigger to auto-generate quote numbers
CREATE OR REPLACE FUNCTION set_quote_number()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.quote_number IS NULL OR NEW.quote_number = '' THEN
        NEW.quote_number := generate_quote_number();
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_set_quote_number
    BEFORE INSERT ON public.course_quotes
    FOR EACH ROW
    EXECUTE FUNCTION set_quote_number();
```

## Row Level Security Policies

### Individual Courses Table

```sql
-- Enable RLS
ALTER TABLE public.individual_courses ENABLE ROW LEVEL SECURITY;

-- Allow instructors to manage all individual courses
CREATE POLICY "Instructors can manage individual courses" ON public.individual_courses
FOR ALL TO authenticated
USING (auth.jwt() ->> 'role' = 'instructor')
WITH CHECK (auth.jwt() ->> 'role' = 'instructor');

-- Allow students to view their own courses
CREATE POLICY "Students can view own individual courses" ON public.individual_courses
FOR SELECT TO authenticated
USING (student_id = (auth.jwt() ->> 'sub')::BIGINT);
```

### Individual Sessions Table

```sql
-- Enable RLS
ALTER TABLE public.individual_sessions ENABLE ROW LEVEL SECURITY;

-- Allow instructors to manage all sessions
CREATE POLICY "Instructors can manage individual sessions" ON public.individual_sessions
FOR ALL TO authenticated
USING (auth.jwt() ->> 'role' = 'instructor')
WITH CHECK (auth.jwt() ->> 'role' = 'instructor');

-- Allow students to view sessions for their courses
CREATE POLICY "Students can view own individual sessions" ON public.individual_sessions
FOR SELECT TO authenticated
USING (
    individual_course_id IN (
        SELECT id FROM public.individual_courses 
        WHERE student_id = (auth.jwt() ->> 'sub')::BIGINT
    )
);
```

### Course Quotes Table

```sql
-- Enable RLS
ALTER TABLE public.course_quotes ENABLE ROW LEVEL SECURITY;

-- Allow instructors to manage all quotes
CREATE POLICY "Instructors can manage course quotes" ON public.course_quotes
FOR ALL TO authenticated
USING (auth.jwt() ->> 'role' = 'instructor')
WITH CHECK (auth.jwt() ->> 'role' = 'instructor');

-- Allow anonymous users to view quotes they receive (via secure link)
CREATE POLICY "Allow quote viewing via secure access" ON public.course_quotes
FOR SELECT TO anon
USING (true); -- Additional security through application-level token validation
```

## Data Migration Considerations

### Existing Data Compatibility

The new schema additions are designed to be fully backward compatible with existing data. All new columns include appropriate default values, and existing functionality will continue to work without modification.

### Contact Form Integration

The enhanced contacts table will automatically capture additional information when users express interest in individual courses. The contact form can be updated to include optional fields for course type preference and availability information.

### Subscription System Integration

Individual courses will integrate seamlessly with the existing subscription system while maintaining their unique characteristics through the custom pricing and duration fields.

## Business Logic Implementation

### Quote Generation Workflow

1. **Initial Inquiry**: Contact form submission creates entry in contacts table
2. **Course Assessment**: Instructor reviews inquiry and creates individual_course record
3. **Quote Creation**: System generates quote with custom pricing based on requirements
4. **Quote Delivery**: Quote sent to prospective student with secure viewing link
5. **Quote Acceptance**: Accepted quote triggers course confirmation and scheduling
6. **Course Delivery**: Individual sessions tracked through individual_sessions table

### Pricing Flexibility

The schema supports multiple pricing models for individual courses:
- **Hourly Rate**: Standard rate per hour of instruction
- **Package Pricing**: Fixed price for complete course package
- **Custom Pricing**: Fully customized pricing based on specific requirements
- **Tiered Pricing**: Different rates based on course complexity or student level

### Progress Tracking

Individual course progress is tracked through multiple mechanisms:
- **Session Completion**: Number of completed sessions vs. total planned
- **Learning Objectives**: Progress toward specific goals defined in course setup
- **Performance Metrics**: Instructor assessments and student feedback
- **Material Coverage**: Topics covered vs. planned curriculum

## Analytics and Reporting Capabilities

### Business Intelligence

The enhanced schema provides comprehensive data for business analytics:
- **Conversion Rates**: Track inquiry-to-enrollment conversion for individual courses
- **Pricing Analysis**: Analyze quote acceptance rates by price point and course type
- **Scheduling Patterns**: Understand preferred scheduling patterns for individual instruction
- **Student Satisfaction**: Track completion rates and feedback for individual courses

### Performance Metrics

Key performance indicators supported by the schema:
- **Revenue per Individual Course**: Average revenue generated per individual course
- **Time to Conversion**: Average time from inquiry to course start
- **Session Completion Rate**: Percentage of scheduled sessions actually completed
- **Student Retention**: Percentage of students completing full individual course

### Instructor Efficiency

Metrics to optimize instructor time and effectiveness:
- **Preparation Time**: Time spent preparing for individual sessions
- **Session Effectiveness**: Student progress per hour of instruction
- **Scheduling Efficiency**: Optimal scheduling patterns for individual courses
- **Resource Utilization**: Most effective materials and teaching methods

## Implementation Recommendations

### Phase 1: Core Tables

1. Create individual_courses table with basic functionality
2. Create individual_sessions table for session tracking
3. Update contacts table with course type preferences
4. Implement basic RLS policies

### Phase 2: Enhanced Features

1. Create course_quotes table with quote generation
2. Implement automatic quote numbering system
3. Add custom pricing fields to subscriptions table
4. Create comprehensive RLS policies

### Phase 3: Advanced Analytics

1. Create database views for common queries
2. Implement stored procedures for complex operations
3. Add triggers for automatic data updates
4. Create reporting functions for business intelligence

## Security Considerations

### Data Protection

Individual courses contain sensitive personal information requiring enhanced protection:
- **Personal Learning Goals**: Student-specific objectives and challenges
- **Performance Data**: Detailed progress and assessment information
- **Financial Information**: Custom pricing and payment details
- **Communication Records**: Private instructor-student communications

### Access Control

Strict access controls ensure data privacy:
- **Role-Based Access**: Different permissions for instructors, students, and administrators
- **Data Segregation**: Students can only access their own course information
- **Audit Logging**: Track all access to sensitive individual course data
- **Secure Communications**: Encrypted storage of private notes and feedback

### Compliance Requirements

The schema design supports compliance with data protection regulations:
- **Data Minimization**: Only collect necessary information for course delivery
- **Purpose Limitation**: Use data only for stated educational purposes
- **Retention Policies**: Automatic cleanup of old course data
- **User Rights**: Support for data access, correction, and deletion requests

## Conclusion

The database schema updates outlined in this document provide comprehensive support for individual course offerings while maintaining compatibility with existing functionality. The design emphasizes flexibility, security, and analytical capabilities to support the growth and optimization of the individual course business model.

The implementation of these schema changes will enable BridgeFacile to offer truly personalized bridge instruction with professional quote management, detailed progress tracking, and comprehensive business analytics. This foundation supports both current requirements and future expansion of the individual course offering.

